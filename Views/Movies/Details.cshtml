@model MovieEventBooking.Models.Movie
@{
    ViewData["Title"] = "Book Tickets";
}

<div class="container-fluid py-5" style="background:linear-gradient(135deg, #0b0c10, #1e3c72); min-height:100vh; color:white;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-lg border-0 p-4" style="border-radius:20px; background-color:#141b29; color:white;">
                    <div class="row">
                        <div class="col-md-5">
                            <img src="@Model.Image" alt="@Model.Title" class="img-fluid rounded" style="border-radius:15px;">
                        </div>
                        <div class="col-md-7">
                            <h2 class="fw-bold text-warning">@Model.Title</h2>
                            <p class="mb-1"><i class="bi bi-film"></i> Genre: <span class="text-info">@Model.Genre</span></p>
                            <p class="mb-1"><i class="bi bi-clock"></i> Duration: <span class="text-info">@Model.Duration</span></p>
                            <p class="mb-1"><i class="bi bi-currency-rupee"></i>@Model.Price</p>
                        </div>
                    </div>

                    <hr class="text-secondary" />

                    <!-- 🎟 User Name -->
                    <h4 class="fw-bold text-warning mb-3 text-center"> Enter Your Name</h4>
                    <input id="userNameInput" type="text" placeholder="Enter your full name"
                           class="form-control mb-4 text-center"
                           style="background-color:#0b0c10; color:white; border-radius:10px;" />

                    <h4 class="fw-bold text-warning mb-3 text-center"> Select Your Theater</h4>
                    <select id="theaterSelect" class="form-select mb-4 text-center" style="background-color:#0b0c10; color:white; border-radius:10px;">
                        @foreach (var theater in Model.Theaters)
                        {
                            <option>@theater</option>
                        }
                    </select>

                    <h4 class="fw-bold text-warning mb-3 text-center"> Choose Your Seats</h4>
                    <div class="seat-grid d-flex flex-wrap justify-content-center gap-2 mb-4">
                        @foreach (var seat in Model.Seats)
                        {
                            bool isBooked = seat.Contains("X");
                            <button class="seat-btn @(isBooked ? "booked" : "available")" @(isBooked ? "disabled" : "")>@seat.Replace("X", "")</button>
                        }
                    </div>

                    <h4 class="fw-bold text-warning mb-3 text-center"> Select Payment Method</h4>
                    <select id="paymentMethod" class="form-select mb-4 text-center" style="background-color:#0b0c10; color:white; border-radius:10px;">
                        <option>Cash on Delivery</option>
                        <option>UPI Payment</option>
                        <option>Debit/Credit Card</option>
                        <option>Net Banking</option>
                    </select>

                    <div class="text-center">
                        <button id="confirmBooking" class="btn btn-warning fw-bold px-5 py-2" style="border-radius:10px;">Confirm Booking</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🎉 Confirmation Modal -->
<div id="confirmationModal" class="modal-overlay d-none">
    <div class="modal-content text-center">
        <h2 class="text-warning mb-3"><i class="bi bi-ticket-detailed-fill"></i> Booking Confirmed!</h2>
        <p> Your movie ticket has been successfully booked.</p>
        <hr class="text-secondary">
        <p><strong>Name:</strong> <span id="userNameDisplay"></span></p>
        <p><strong>Movie:</strong> <span id="movieName"></span></p>
        <p><strong>Theater:</strong> <span id="theaterName"></span></p>
        <p><strong>Seats:</strong> <span id="selectedSeats"></span></p>
        <p><strong>Payment:</strong> <span id="selectedPayment"></span></p>
        <p><strong>Date:</strong> @DateTime.Now.ToString("dd MMM yyyy")</p>
        <div class="my-3">
            <i class="bi bi-check-circle-fill text-success" style="font-size:60px;"></i>
        </div>
        <div class="d-flex justify-content-center gap-3">
            <button id="downloadTicket" class="btn btn-outline-warning fw-bold px-4 py-2" style="border-radius:25px;">
                <i class="bi bi-file-earmark-arrow-down-fill"></i> Download Ticket
            </button>
            <a href="/Movies/Index" class="btn btn-warning fw-bold px-4 py-2" style="border-radius:25px;">Back to Home</a>
        </div>
    </div>
</div>

<style>
    .seat-btn {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        border: none;
        font-weight: bold;
        color: white;
        transition: transform 0.2s, background-color 0.2s;
    }

        .seat-btn.available {
            background-color: #1abc9c;
        }

            .seat-btn.available:hover {
                background-color: #16a085;
                transform: scale(1.1);
            }

        .seat-btn.booked {
            background-color: #e74c3c;
        }

        .seat-btn.selected {
            background-color: #f1c40f;
            color: black;
        }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        z-index: 1000;
    }

    .modal-content {
        background-color: #141b29;
        padding: 40px;
        border-radius: 20px;
        width: 450px;
        box-shadow: 0 0 25px rgba(255, 193, 7, 0.4);
        animation: fadeIn 0.5s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .d-none {
        display: none;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const seats = document.querySelectorAll(".seat-btn.available");
        const confirmBtn = document.getElementById("confirmBooking");
        const modal = document.getElementById("confirmationModal");
        const movieName = "@Model.Title";

        let selectedSeats = "";

        seats.forEach(btn => {
            btn.addEventListener("click", () => {
                btn.classList.toggle("selected");
            });
        });

        confirmBtn.addEventListener("click", () => {
            const userName = document.getElementById("userNameInput").value.trim();
            if (!userName) {
                alert("Please enter your name!");
                return;
            }

            selectedSeats = Array.from(document.querySelectorAll(".seat-btn.selected")).map(b => b.textContent).join(", ");
            const selectedPayment = document.getElementById("paymentMethod").value;
            const theater = document.getElementById("theaterSelect").value;

            if (!selectedSeats) {
                alert("Please select at least one seat!");
                return;
            }

            document.getElementById("userNameDisplay").textContent = userName;
            document.getElementById("movieName").textContent = movieName;
            document.getElementById("theaterName").textContent = theater;
            document.getElementById("selectedSeats").textContent = selectedSeats;
            document.getElementById("selectedPayment").textContent = selectedPayment;

            modal.classList.remove("d-none");

            // Save booking info for ticket download
            window.ticketInfo = { userName, movieName, theater, selectedSeats, selectedPayment };
        });

        document.getElementById("downloadTicket").addEventListener("click", () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text(" Movie Ticket", 80, 20);
            doc.setFontSize(14);
            doc.text(`Name: ${window.ticketInfo.userName}`, 20, 40);
            doc.text(`Movie: ${window.ticketInfo.movieName}`, 20, 50);
            doc.text(`Theater: ${window.ticketInfo.theater}`, 20, 60);
            doc.text(`Seats: ${window.ticketInfo.selectedSeats}`, 20, 70);
            doc.text(`Payment: ${window.ticketInfo.selectedPayment}`, 20, 80);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 90);

            doc.setFontSize(12);
            doc.text("Enjoy your movie! ", 70, 110);

            doc.save(`${window.ticketInfo.movieName}_Ticket.pdf`);
        });
    });
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
